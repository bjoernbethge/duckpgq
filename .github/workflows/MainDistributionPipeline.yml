#
# This workflow calls the main distribution pipeline from DuckDB to build, test and (optionally) release the extension
#
name: Main Extension Distribution Pipeline
on:
  push:
    tags:
      - 'v*'
    branches:
      - main
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.head_ref || '' }}-${{ github.base_ref || '' }}-${{ github.ref != 'refs/heads/main' && github.sha || '' }}
  cancel-in-progress: true

jobs:
  duckdb-stable-build:
    name: Build extension binaries
    uses: duckdb/extension-ci-tools/.github/workflows/_extension_distribution.yml@v1.4.3
    with:
      duckdb_version: v1.4.3
      ci_tools_version: v1.4.3
      extension_name: duckpgq

  code-quality-check:
    name: Code Quality Check
    uses: duckdb/extension-ci-tools/.github/workflows/_extension_code_quality.yml@v1.4.3
    with:
      duckdb_version: v1.4.3
      ci_tools_version: main
      extension_name: duckpgq
      format_checks: 'format;tidy'

  # =========================================================================
  # Automatic GitHub Release on Tags
  # Creates releases with pre-built binaries for all platforms
  # Usage: git tag v1.0.0 && git push origin v1.0.0
  # =========================================================================
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: duckdb-stable-build
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Windows AMD64
        uses: actions/download-artifact@v4
        with:
          name: duckpgq-v1.4.3-extension-windows_amd64
          path: ./artifacts/windows_amd64
        continue-on-error: true

      - name: Download Windows AMD64 (MinGW)
        uses: actions/download-artifact@v4
        with:
          name: duckpgq-v1.4.3-extension-windows_amd64_mingw
          path: ./artifacts/windows_amd64_mingw
        continue-on-error: true

      - name: Download Linux AMD64
        uses: actions/download-artifact@v4
        with:
          name: duckpgq-v1.4.3-extension-linux_amd64
          path: ./artifacts/linux_amd64
        continue-on-error: true

      - name: Download Linux AMD64 (GCC4)
        uses: actions/download-artifact@v4
        with:
          name: duckpgq-v1.4.3-extension-linux_amd64_gcc4
          path: ./artifacts/linux_amd64_gcc4
        continue-on-error: true

      - name: Download Linux ARM64
        uses: actions/download-artifact@v4
        with:
          name: duckpgq-v1.4.3-extension-linux_arm64
          path: ./artifacts/linux_arm64
        continue-on-error: true

      - name: Download macOS AMD64
        uses: actions/download-artifact@v4
        with:
          name: duckpgq-v1.4.3-extension-osx_amd64
          path: ./artifacts/osx_amd64
        continue-on-error: true

      - name: Download macOS ARM64
        uses: actions/download-artifact@v4
        with:
          name: duckpgq-v1.4.3-extension-osx_arm64
          path: ./artifacts/osx_arm64
        continue-on-error: true

      - name: Prepare release files
        run: |
          mkdir -p dist
          for dir in artifacts/*/; do
            platform=$(basename "$dir")
            if [ -f "$dir/duckpgq.duckdb_extension" ]; then
              cp "$dir/duckpgq.duckdb_extension" "dist/duckpgq-${platform}.duckdb_extension"
              echo "Added: duckpgq-${platform}.duckdb_extension"
            fi
          done
          cd dist
          sha256sum *.duckdb_extension > checksums.txt || true
          echo "=== Release files ==="
          ls -la

      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ github.ref_name }}             --title "DuckPGQ ${{ github.ref_name }} (DuckDB v1.4.3)"             --generate-notes             ./dist/* || echo "Release creation failed or already exists"
